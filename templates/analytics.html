<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Cyber Attack Storyteller</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="/static/shared.js"></script>
</head>
<body class="analytics-page">
    <div class="container">
        <header>
            <h1>Cyber Attack Storyteller</h1>
            <p>Statistical Analysis & Network Intelligence</p>
        </header>

        <div class="upload-area">
            <h2>Analytics Dashboard</h2>
            <p id="loading-msg" style="color: #f39c12;">Loading analytics...</p>
        </div>

        <div id="analytics-content" style="display:none;">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Event Type Distribution</h3>
                    <canvas id="eventChart"></canvas>
                </div>
                <div class="analytics-card">
                    <h3>Top Source IPs</h3>
                    <canvas id="sourceChart"></canvas>
                </div>
                <div class="analytics-card">
                    <h3>Top Destination IPs</h3>
                    <canvas id="destChart"></canvas>
                </div>
                <div class="analytics-card">
                    <h3>Port Distribution</h3>
                    <canvas id="portChart"></canvas>
                </div>
            </div>

            <div class="analytics-summary">
                <div class="summary-item">
                    <strong>Total Events:</strong> <span id="total-events">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('loading-msg').textContent = 'No data available. Analyze a PCAP first.';
                    return;
                }

                renderCharts(data);
                document.getElementById('analytics-content').style.display = 'block';
                document.getElementById('loading-msg').style.display = 'none';
            } catch (err) {
                document.getElementById('loading-msg').textContent = 'Error loading analytics';
            }
        }

        function renderCharts(data) {
            document.getElementById('total-events').textContent = data.total_events;

            // Event Type Distribution
            const eventCtx = document.getElementById('eventChart').getContext('2d');
            charts.eventChart = new Chart(eventCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.event_counts),
                    datasets: [{
                        data: Object.values(data.event_counts),
                        backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e']
                    }]
                },
                options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0e0' } } } }
            });

            // Top Sources
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');
            charts.sourceChart = new Chart(sourceCtx, {
                type: 'bar',
                data: {
                    labels: data.top_sources.map(x => x[0]),
                    datasets: [{
                        label: 'Count',
                        data: data.top_sources.map(x => x[1]),
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: { x: { ticks: { color: '#e0e0e0' }, grid: { color: '#2c3e50' } }, y: { ticks: { color: '#e0e0e0' }, grid: { color: '#2c3e50' } } }
                }
            });

            // Top Destinations
            const destCtx = document.getElementById('destChart').getContext('2d');
            charts.destChart = new Chart(destCtx, {
                type: 'bar',
                data: {
                    labels: data.top_destinations.map(x => x[0]),
                    datasets: [{
                        label: 'Count',
                        data: data.top_destinations.map(x => x[1]),
                        backgroundColor: '#2ecc71'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: { x: { ticks: { color: '#e0e0e0' }, grid: { color: '#2c3e50' } }, y: { ticks: { color: '#e0e0e0' }, grid: { color: '#2c3e50' } } }
                }
            });

            // Port Distribution
            const portCtx = document.getElementById('portChart').getContext('2d');
            charts.portChart = new Chart(portCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data.port_distribution).slice(0, 10),
                    datasets: [{
                        label: 'Frequency',
                        data: Object.values(data.port_distribution).slice(0, 10),
                        backgroundColor: '#e74c3c'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: { x: { ticks: { color: '#e0e0e0' }, grid: { color: '#2c3e50' } }, y: { ticks: { color: '#e0e0e0' }, grid: { color: '#2c3e50' } } }
                }
            });
        }

        loadAnalytics();
    </script>
</body>

</html>