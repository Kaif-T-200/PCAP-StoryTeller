<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Analysis - Cyber Attack Storyteller</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/shared.js"></script>
</head>
<body class="threats-page">
    <div class="container">
        <header>
            <h1>Cyber Attack Storyteller</h1>
            <p>Threat Intelligence & Attack Pattern Detection</p>
        </header>

        <div id="loading-msg" class="upload-area" style="text-align: center; color: #f39c12;">
            Loading threat analysis...
        </div>

        <div id="threats-content" style="display:none;">
            <div class="threat-summary">
                <div class="summary-box">
                    <h3>Overall Threat Level</h3>
                    <div id="threat-level" class="threat-badge">—</div>
                    <p id="threat-score">Threat Score: —</p>
                </div>
                <div class="summary-box">
                    <h3>Quick Stats</h3>
                    <p>High Threat Events: <strong id="high-threat-count">0</strong></p>
                    <p>Detected Patterns: <strong id="pattern-count">0</strong></p>
                </div>
            </div>

            <div class="threat-section">
                <h2>Detected Attack Patterns</h2>
                <div id="patterns-list">
                    <p style="color: #b0bec5;">No suspicious patterns detected.</p>
                </div>
            </div>

            <div class="threat-section">
                <h2>Event Risk Scores</h2>
                <div id="risk-scoreboard" style="max-height: 500px; overflow-y: auto;">
                    <p style="color: #b0bec5;">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadThreats() {
            try {
                const response = await fetch('/api/threats');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('loading-msg').textContent = 'No data available. Analyze a PCAP first.';
                    return;
                }

                renderThreats(data);
                document.getElementById('threats-content').style.display = 'block';
                document.getElementById('loading-msg').style.display = 'none';
            } catch (err) {
                document.getElementById('loading-msg').textContent = 'Error loading threats';
            }
        }

        function renderThreats(data) {
            const summary = data.summary;
            const threatLevel = summary.threat_level;
            const threatColor = {
                'CRITICAL': '#e74c3c',
                'HIGH': '#e67e22',
                'MEDIUM': '#f39c12',
                'LOW': '#2ecc71'
            }[threatLevel] || '#95a5a6';

            const badge = document.getElementById('threat-level');
            badge.textContent = threatLevel;
            badge.style.color = threatColor;

            document.getElementById('threat-score').textContent = `Threat Score: ${summary.overall_score}/100`;
            document.getElementById('high-threat-count').textContent = summary.high_threat_count;
            document.getElementById('pattern-count').textContent = summary.pattern_count;

            // Patterns
            const patternsList = document.getElementById('patterns-list');
            if (summary.patterns.length === 0) {
                patternsList.innerHTML = '<p style="color: #b0bec5;">No suspicious patterns detected.</p>';
            } else {
                patternsList.innerHTML = summary.patterns.map(p => `
                    <div class="pattern-card">
                        <strong>${p.type.toUpperCase()}</strong> - ${p.severity}
                        <p>${p.description}</p>
                    </div>
                `).join('');
            }

            // Risk Scoreboard
            const scoreboard = document.getElementById('risk-scoreboard');
            const eventScores = Object.entries(data.threat_scores)
                .map(([id, score]) => ({ id: parseInt(id), score }))
                .sort((a, b) => b.score - a.score);

            scoreboard.innerHTML = eventScores.slice(0, 20).map(item => {
                const color = item.score >= 60 ? '#e74c3c' : item.score >= 40 ? '#e67e22' : '#f39c12';
                return `
                    <div class="risk-item">
                        <span>Event #${item.id}</span>
                        <div class="risk-bar">
                            <div class="risk-fill" style="width: ${item.score}%; background: ${color};"></div>
                        </div>
                        <span>${item.score}</span>
                    </div>
                `;
            }).join('');
        }

        loadThreats();
    </script>

    <style>
        .threat-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-box {
            background: #1e2a3a;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .threat-badge {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .threat-section {
            background: #1e2a3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .threat-section h2 {
            color: #64b5f6;
            margin-bottom: 15px;
            border-bottom: 1px solid #2c3e50;
            padding-bottom: 10px;
        }

        .pattern-card {
            background: #0f1a24;
            border-left: 3px solid #e67e22;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .risk-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .risk-bar {
            flex: 1;
            height: 20px;
            background: #2c3e50;
            border-radius: 4px;
            overflow: hidden;
        }

        .risk-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</body>

</html>